/* 
 * a-tools 1.5.2
 * 
 * Copyright (c) 2009 Andrey Kramarev(andrey.kramarev[at]ampparit.com), Ampparit Inc. (www.ampparit.com)
 * Licensed under the MIT license.
 * http://www.ampparit.fi/a-tools/license.txt
 *
 * Basic usage:
 
    <textarea></textarea>
    <input type="text" />

    // Get current selection
    var sel = $("textarea").getSelection()
    
    // Replace current selection
    $("input").replaceSelection("foo");

    // Count characters
    alert($("textarea").countCharacters());

    // Set max length without callback function
    $("textarea").setMaxLength(7);

    // Set max length with callback function which will be called when limit is exceeded
    $("textarea").setMaxLength(10, function() {
        alert("hello")
    });

    // Removing limit:
    $("textarea").setMaxLength(-1);
    
    // Insert text at current caret position
    $("#textarea").insertAtCaretPos("hello");
    
    // Set caret position (1 = beginning, -1 = end)
    $("#textArea").setCaretPos(10);
    
    // Set Selection
    $("#textArea").setSelection(10,15);

 */
var caretPositionAmp=new Array();function init(){if(navigator.appName=="Microsoft Internet Explorer"){obj=document.getElementsByTagName("TEXTAREA");var a;var b=0;for(var b=0;b<obj.length;b++){a=obj[b];caretPositionAmp[b]=a.value.length;a.onmouseup=function(){a=document.activeElement;for(var c=0;c<obj.length;c++){if(obj[c]==a){break}}a.focus();var e=document.selection.createRange();var d=a.createTextRange();var f=d.duplicate();d.moveToBookmark(e.getBookmark());f.setEndPoint("EndToStart",d);caretPositionAmp[c]=f.text.length};a.onkeyup=function(){a=document.activeElement;for(var c=0;c<obj.length;c++){if(obj[c]==a){break}}a.focus();var e=document.selection.createRange();var d=a.createTextRange();var f=d.duplicate();d.moveToBookmark(e.getBookmark());f.setEndPoint("EndToStart",d);caretPositionAmp[c]=f.text.length}}}}window.onload=init;jQuery.fn.extend({getSelection:function(){var m=this.jquery?this[0]:this;var b;var f;var c;var d=0;m.onmousedown=function(){if(document.selection&&typeof(m.selectionStart)!="number"){document.selection.empty()}else{window.getSelection().removeAllRanges()}};if(document.selection){var p=document.selection.createRange();var e=0;var k=0;var g=0;var o;var a;var j=document.getElementsByTagName("TEXTAREA");var l=0;for(l;l<j.length;l++){if(j[l]==m){break}}if(m.value.match(/\n/g)!=null){d=m.value.match(/\n/g).length}if(p.text){c=p.text;if(typeof(m.selectionStart)=="number"){b=m.selectionStart;f=m.selectionEnd;if(b==f){return{start:b,end:f,text:p.text,length:f-b}}}else{o=m.createTextRange();a=o.duplicate();firstRe=o.text;o.moveToBookmark(p.getBookmark());secondRe=o.text;a.setEndPoint("EndToStart",o);if(firstRe==secondRe&&firstRe!=p.text||a.text.length>firstRe.length){return{start:caretPositionAmp[l],end:caretPositionAmp[l],text:"",length:0}}b=a.text.length;f=a.text.length+p.text.length}if(d>0){for(var h=0;h<=d;h++){var n=m.value.indexOf("\n",k);if(n!=-1&&n<b){k=n+1;e++;g=e}else{if(n!=-1&&n>=b&&n<=f){if(n==b+1){e--;g--;k=n+1;continue}k=n+1;g++}else{h=d}}}}if(p.text.indexOf("\n",0)==1){g=g+2}b=b-e;f=f-g;return{start:b,end:f,text:p.text,length:f-b}}m.focus();if(typeof(m.selectionStart)=="number"){b=m.selectionStart}else{p=document.selection.createRange();o=m.createTextRange();a=o.duplicate();o.moveToBookmark(p.getBookmark());a.setEndPoint("EndToStart",o);b=a.text.length}if(d>0){for(var h=0;h<=d;h++){var n=m.value.indexOf("\n",k);if(n!=-1&&n<b){k=n+1;e++}else{h=d}}}b=b-e;if(b==0&&typeof(m.selectionStart)!="number"){b=caretPositionAmp[l];f=caretPositionAmp[l]}return{start:b,end:b,text:p.text,length:0}}else{if(typeof(m.selectionStart)=="number"){b=m.selectionStart;f=m.selectionEnd;c=m.value.substring(m.selectionStart,m.selectionEnd);return{start:b,end:f,text:c,length:f-b}}else{return{start:undefined,end:undefined,text:undefined,length:undefined}}}},replaceSelection:function(k){var j=this.jquery?this[0]:this;var e;var d;var t=0;var p;var n;var a=0;var b=0;var c=(j.scrollTop==undefined)?0:j.scrollTop;var l=document.getElementsByTagName("TEXTAREA");var g=0;for(g;g<l.length;g++){if(l[g]==j){break}}if(document.selection&&typeof(j.selectionStart)!="number"){var m=document.selection.createRange();if(typeof(j.selectionStart)!="number"){var o;var r;n=j.createTextRange();p=n.duplicate();o=n.text;n.moveToBookmark(m.getBookmark());r=n.text;try{p.setEndPoint("EndToStart",n)}catch(f){return this}if(o==r&&o!=m.text||p.text.length>o.length){return this}}if(m.text){part=m.text;if(j.value.match(/\n/g)!=null){a=j.value.match(/\n/g).length}e=p.text.length;if(a>0){for(var q=0;q<=a;q++){var h=j.value.indexOf("\n",t);if(h!=-1&&h<e){t=h+1;b++}else{q=a}}}m.text=k;caretPositionAmp[g]=p.text.length+k.length;n.move("character",caretPositionAmp[g]);document.selection.empty();j.blur()}return this}else{if(typeof(j.selectionStart)=="number"&&j.selectionStart!=j.selectionEnd){e=j.selectionStart;d=j.selectionEnd;j.value=j.value.substr(0,e)+k+j.value.substr(d);t=e+k.length;j.setSelectionRange(t,t);j.scrollTop=c;return this}}return this},setSelection:function(d,b){d=parseInt(d);b=parseInt(b);var h=this.jquery?this[0]:this;h.focus();if(typeof(h.selectionStart)!="number"){re=h.createTextRange();if(re.text.length<b){b=re.text.length+1}}if(b<d){return this}if(document.selection){var c=0;var g=0;var f=0;var a=0;if(typeof(h.selectionStart)!="number"){re.collapse(true);re.moveEnd("character",b);re.moveStart("character",d);re.select();return this}else{if(typeof(h.selectionStart)=="number"){if(h.value.match(/\n/g)!=null){c=h.value.match(/\n/g).length}if(c>0){for(var e=0;e<=c;e++){var j=h.value.indexOf("\n",f);if(j!=-1&&j<d){f=j+1;g++;a=g}else{if(j!=-1&&j>=d&&j<=b){if(j==d+1){g--;a--;f=j+1;continue}f=j+1;a++}else{e=c}}}}d=d+g;b=b+a;h.selectionStart=d;h.selectionEnd=b;h.focus();return this}else{h.focus();return this}}}else{if(h.selectionStart||h.selectionStart==0){h.focus();window.getSelection().removeAllRanges();h.selectionStart=d;h.selectionEnd=b;h.focus();return this}}},insertAtCaretPos:function(k){var m=this.jquery?this[0]:this;var b;var e;var j;var q;var p;var a;var o;var d=0;var c=0;var h=(m.scrollTop==undefined)?0:m.scrollTop;var g=document.getElementsByTagName("TEXTAREA");var l=0;for(l;l<g.length;l++){if(g[l]==m){break}}m.focus();if(document.selection&&typeof(m.selectionStart)!="number"){if(m.value.match(/\n/g)!=null){c=m.value.match(/\n/g).length}o=parseInt(caretPositionAmp[l]);if(c>0){for(var f=0;f<=c;f++){var n=m.value.indexOf("\n",j);if(n!=-1&&n<=o){j=n+1;o=o-1;d++}}}}caretPositionAmp[l]=parseInt(caretPositionAmp[l]);m.onkeyup=function(){if(document.selection&&typeof(m.selectionStart)!="number"){m.focus();q=document.selection.createRange();p=m.createTextRange();a=p.duplicate();p.moveToBookmark(q.getBookmark());a.setEndPoint("EndToStart",p);caretPositionAmp[l]=a.text.length}};m.onmouseup=function(){if(document.selection&&typeof(m.selectionStart)!="number"){m.focus();q=document.selection.createRange();p=m.createTextRange();a=p.duplicate();p.moveToBookmark(q.getBookmark());a.setEndPoint("EndToStart",p);caretPositionAmp[l]=a.text.length}};if(document.selection&&typeof(m.selectionStart)!="number"){q=document.selection.createRange();if(q.text.length!=0){return this}p=m.createTextRange();textLength=p.text.length;a=p.duplicate();p.moveToBookmark(q.getBookmark());a.setEndPoint("EndToStart",p);b=a.text.length;if(caretPositionAmp[l]>0&&b==0){d=caretPositionAmp[l]-d;p.move("character",d);p.select();q=document.selection.createRange();caretPositionAmp[l]+=k.length}else{if(!(caretPositionAmp[l]>=0)&&textLength==0){q=document.selection.createRange();caretPositionAmp[l]=k.length+textLength}else{if(!(caretPositionAmp[l]>=0)&&b==0){p.move("character",textLength);p.select();q=document.selection.createRange();caretPositionAmp[l]=k.length+textLength}else{if(!(caretPositionAmp[l]>=0)&&b>0){p.move("character",0);document.selection.empty();p.select();q=document.selection.createRange();caretPositionAmp[l]=b+k.length}else{if(caretPositionAmp[l]>=0&&caretPositionAmp[l]==textLength){if(textLength!=0){p.move("character",textLength);p.select()}else{p.move("character",0)}q=document.selection.createRange();caretPositionAmp[l]=k.length+textLength}else{if(caretPositionAmp[l]>=0&&b!=0&&caretPositionAmp[l]>=b){d=caretPositionAmp[l]-b;p.move("character",d);document.selection.empty();p.select();q=document.selection.createRange();caretPositionAmp[l]=caretPositionAmp[l]+k.length}else{if(caretPositionAmp[l]>=0&&b!=0&&caretPositionAmp[l]<b){p.move("character",0);document.selection.empty();p.select();q=document.selection.createRange();caretPositionAmp[l]=caretPositionAmp[l]+k.length}else{document.selection.empty();p.select();q=document.selection.createRange();caretPositionAmp[l]=caretPositionAmp[l]+k.length}}}}}}}q.text=k;m.focus();return this}else{if(typeof(m.selectionStart)=="number"&&m.selectionStart==m.selectionEnd){j=m.selectionStart+k.length;b=m.selectionStart;e=m.selectionEnd;m.value=m.value.substr(0,b)+k+m.value.substr(e);m.setSelectionRange(j,j);m.scrollTop=h;return this}}return this},setCaretPos:function(f){var h=this.jquery?this[0]:this;var l;var k;var e;var a=0;var b=0;var j;var d=document.getElementsByTagName("TEXTAREA");var g=0;for(g;g<d.length;g++){if(d[g]==h){break}}h.focus();if(parseInt(f)==0){return this}if(parseInt(f)>0){f=parseInt(f)-1;if(document.selection&&typeof(h.selectionStart)=="number"&&h.selectionStart==h.selectionEnd){if(h.value.match(/\n/g)!=null){a=h.value.match(/\n/g).length}if(a>0){for(var c=0;c<=a;c++){j=h.value.indexOf("\n",e);if(j!=-1&&j<=f){e=j+1;f=parseInt(f)+1}}}}}else{if(parseInt(f)<0){f=parseInt(f)+1;if(document.selection&&typeof(h.selectionStart)!="number"){f=h.value.length+parseInt(f);if(h.value.match(/\n/g)!=null){a=h.value.match(/\n/g).length}if(a>0){for(var c=0;c<=a;c++){j=h.value.indexOf("\n",e);if(j!=-1&&j<=f){e=j+1;f=parseInt(f)-1;b+=1}}f=f+b-a}}else{if(document.selection&&typeof(h.selectionStart)=="number"){f=h.value.length+parseInt(f);if(h.value.match(/\n/g)!=null){a=h.value.match(/\n/g).length}if(a>0){f=parseInt(f)-a;for(var c=0;c<=a;c++){j=h.value.indexOf("\n",e);if(j!=-1&&j<=(f)){e=j+1;f=parseInt(f)+1;b+=1}}}}else{f=h.value.length+parseInt(f)}}}else{return this}}if(document.selection&&typeof(h.selectionStart)!="number"){l=document.selection.createRange();if(l.text!=0){return this}k=h.createTextRange();k.collapse(true);k.moveEnd("character",f);k.moveStart("character",f);k.select();caretPositionAmp[g]=f;return this}else{if(typeof(h.selectionStart)=="number"&&h.selectionStart==h.selectionEnd){h.setSelectionRange(f,f);return this}}return this},countCharacters:function(b){var a=this.jquery?this[0]:this;if(a.value.match(/\r/g)!=null){return a.value.length-a.value.match(/\r/g).length}return a.value.length},setMaxLength:function(a,b){this.each(function(){var d=this.jquery?this[0]:this;var f=d.type;var e;var c;if(parseInt(a)<0){a=100000000}if(f=="text"){d.maxLength=a}if(f=="textarea"||f=="text"){d.onkeypress=function(j){var g=d.value.match(/\r/g);c=a;if(g!=null){c=parseInt(c)+g.length}var h=j||event;var i=h.keyCode;if(document.selection){e=document.selection.createRange().text.length>0}else{e=d.selectionStart!=d.selectionEnd}if(d.value.length>=c&&(i>47||i==32||i==0||i==13)&&!h.ctrlKey&&!h.altKey&&!e){d.value=d.value.substring(0,c);if(typeof(b)=="function"){b()}return false}};d.onkeyup=function(){var h=d.value.match(/\r/g);var k=0;var g=0;c=a;if(h!=null){for(var j=0;j<=h.length;j++){if(d.value.indexOf("\n",g)<=parseInt(a)){k++;g=d.value.indexOf("\n",g)+1}}c=parseInt(a)+k}if(d.value.length>c){d.value=d.value.substring(0,c);if(typeof(b)=="function"){b()}return this}}}else{return this}});return this}});